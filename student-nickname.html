<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { margin: 5px 0; padding: 8px; width: 300px; }
    label { display: block; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô‡∏ô</h2>

  <label for="idCard">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</label>
  <input type="text" id="idCard" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô">
  <button onclick="searchStudent()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>

  <div id="resultSection" style="display:none;">
    <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
    <input type="text" id="studentCode" readonly>

    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á:</label>
    <input type="text" id="firstName" readonly>

    <label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
    <input type="text" id="lastName" readonly>

    <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:</label>
    <input type="text" id="nickname">

    <button onclick="saveNickname()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</button>
  </div>

  <p id="statusMsg" style="color:green;"></p>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzpiMi_AWfAatYujg1Def_ME5FGWjaBH762eOvAkGVKEvHgAe0OayN0sQeZ0sa1goKw/exec';

    async function searchStudent() {
      const idCard = document.getElementById('idCard').value.trim();
      if (!idCard) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô");
        return;
      }

      try {
        const res = await fetch(`${API_URL}?idCard=${idCard}`);
        const data = await res.json();

        if (!data || data.error || !data['‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô']) {
          document.getElementById('statusMsg').textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö";
          document.getElementById('resultSection').style.display = "none";
        } else {
          document.getElementById('studentCode').value = data['‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'];
          document.getElementById('firstName').value = data['‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á'];
          document.getElementById('lastName').value = data['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'];
          document.getElementById('nickname').value = data['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô'] || '';
          document.getElementById('resultSection').style.display = "block";
          document.getElementById('statusMsg').textContent = '';
        }
      } catch (error) {
        console.error(error);
        document.getElementById('statusMsg').textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠";
      }
    }

    async function saveNickname() {
      const idCard = document.getElementById('idCard').value.trim();
      const nickname = document.getElementById('nickname').value.trim();

      if (!nickname) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
        return;
      }

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'updateNickname',
            idCard: idCard,
            nickname: nickname
          })
        });

        const result = await res.json();
        if (result.success) {
          document.getElementById('statusMsg').textContent = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
        } else {
          document.getElementById('statusMsg').textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: " + result.error;
        }
      } catch (error) {
        console.error(error);
        document.getElementById('statusMsg').textContent = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
      }
    }
  </script>
</body>
</html>
