<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { margin: 5px 0; padding: 8px; width: 300px; }
    label { display: block; margin-top: 10px; }
    #statusMsg { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</h2>

  <label for="idCard">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</label>
  <input type="text" id="idCard" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô">
  <button id="searchBtn">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>

  <div id="resultSection" style="display:none;">
    <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
    <input type="text" id="studentCode" readonly>

    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á:</label>
    <input type="text" id="firstName" readonly>

    <label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
    <input type="text" id="lastName" readonly>

    <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:</label>
    <input type="text" id="nickname">

    <button id="saveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</button>
  </div>

  <p id="statusMsg" style="color:green;"></p>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzpiMi_AWfAatYujg1Def_ME5FGWjaBH762eOvAkGVKEvHgAe0OayN0sQeZ0sa1goKw/exec';

    async function searchStudent() {
      const idCard = document.getElementById('idCard').value.trim();
      if (!idCard) {
        Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', '', 'warning');
        return;
      }

      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...', didOpen: () => Swal.showLoading() });

      try {
        const res = await fetch(`${API_URL}?idCard=${idCard}`);
        const data = await res.json();
        Swal.close();

        if (!data || data.error || !data['‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô']) {
          document.getElementById('resultSection').style.display = "none";
          Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', '', 'error');
        } else {
          document.getElementById('studentCode').value = data['‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'];
          document.getElementById('firstName').value = data['‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á'];
          document.getElementById('lastName').value = data['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'];
          document.getElementById('nickname').value = data['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô'] || '';
          document.getElementById('resultSection').style.display = "block";
          document.getElementById('statusMsg').textContent = '';
          Swal.fire('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }
      } catch (error) {
        Swal.close();
        console.error(error);
        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', '', 'error');
      }
    }

    async function saveNickname() {
      const idCard = document.getElementById('idCard').value.trim();
      const nickname = document.getElementById('nickname').value.trim();

      if (!nickname) {
        Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', '', 'warning');
        return;
      }

      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });

      try {
        const params = new URLSearchParams({
          idCard: idCard,
          nickname: nickname,
          action: "updateNickname"
        });

        await fetch(`${API_URL}?${params.toString()}`);
        Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        document.getElementById('statusMsg').textContent = "‚úîÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      } catch (error) {
        console.error(error);
        Swal.fire('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', '', 'error');
      }
    }

    // ‚úÖ Attach event listeners AFTER DOM is ready
    document.getElementById('searchBtn').addEventListener('click', searchStudent);
    document.getElementById('saveBtn').addEventListener('click', saveNickname);
  </script>
</body>
</html>
